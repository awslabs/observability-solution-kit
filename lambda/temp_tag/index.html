<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>O11yv Docs: NodeLambda</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="dark" data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="index.html" class="sidebar-title">O11yv: NodeLambda</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="StArcPJeAizsHwRj7W8ut"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ContextExtractor.html">ContextExtractor</a></div><div class="sidebar-section-children"><a href="LogFormatter.html">LogFormatter</a></div><div class="sidebar-section-children"><a href="TenantLogger.html">TenantLogger</a></div><div class="sidebar-section-children"><a href="TokenDirector.html">TokenDirector</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="0Y93mRfzQyrdAwDSQNq9x"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#appendContextFromSQSMessage">appendContextFromSQSMessage</a></div><div class="sidebar-section-children"><a href="global.html#appendKeys">appendKeys</a></div><div class="sidebar-section-children"><a href="global.html#apply">apply</a></div><div class="sidebar-section-children"><a href="global.html#decode">decode</a></div><div class="sidebar-section-children"><a href="global.html#extract">extract</a></div><div class="sidebar-section-children"><a href="global.html#extractFromEventByKey">extractFromEventByKey</a></div><div class="sidebar-section-children"><a href="global.html#extractFromSQSMessageAttributes">extractFromSQSMessageAttributes</a></div><div class="sidebar-section-children"><a href="global.html#extractFromSQSMessages">extractFromSQSMessages</a></div><div class="sidebar-section-children"><a href="global.html#extractRootfromTraceId">extractRootfromTraceId</a></div><div class="sidebar-section-children"><a href="global.html#getJwtFromRequest">getJwtFromRequest</a></div><div class="sidebar-section-children"><a href="global.html#getLogContext">getLogContext</a></div><div class="sidebar-section-children"><a href="global.html#initFormat">initFormat</a></div><div class="sidebar-section-children"><a href="global.html#initLogger">initLogger</a></div><div class="sidebar-section-children"><a href="global.html#interceptor">interceptor</a></div><div class="sidebar-section-children"><a href="global.html#setLogLevel">setLogLevel</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section class="readme"><article><h1>ollyv: NodeLambda!</h1><br><h2>Metadata</h2><h3>Module System</h3><blockquote><p>This Module support both <code>CommonJS</code> and <code>ES Moulde</code>.</p></blockquote><br><p>🛞 CommonJS</p><pre class="prettyprint source lang-javascript"><code>const { Logger, middlewares, interceptor } = require('@ollyv/lambda');
</code></pre><p>🚀 ES Module</p><pre class="prettyprint source lang-javascript"><code>import { Logger, middlewares, interceptor } from '@ollyv/lambda';
</code></pre><br><h3>Dependencies</h3><p>List of dependencies required for the SDK.</p><pre class="prettyprint source lang-json"><code>{
  &quot;dependencies&quot;: {
    &quot;@aws-lambda-powertools/logger&quot;: &quot;^1.9.0&quot;,
    &quot;@middy/core&quot;: &quot;^4.5.2&quot;,
    &quot;callee&quot;: &quot;^1.1.1&quot;,
    &quot;cookie&quot;: &quot;^0.5.0&quot;,
    &quot;jsonwebtoken&quot;: &quot;^9.0.1&quot;,
    &quot;lodash&quot;: &quot;^4.17.21&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;@babel/cli&quot;: &quot;^7.22.5&quot;,
    &quot;@babel/core&quot;: &quot;^7.22.5&quot;,
    &quot;@babel/preset-env&quot;: &quot;^7.22.5&quot;,
    &quot;aws-sdk&quot;: &quot;^2.1382.0&quot;,
    &quot;babel-jest&quot;: &quot;^29.5.0&quot;,
    &quot;clean-jsdoc-theme&quot;: &quot;^4.2.9&quot;,
    &quot;express&quot;: &quot;^4.18.1&quot;,
    &quot;jest&quot;: &quot;^29.5.0&quot;,
    &quot;jsdoc&quot;: &quot;^4.0.2&quot;,
    &quot;node-fetch&quot;: &quot;^2.6.7&quot;,
    &quot;supertest&quot;: &quot;^6.3.3&quot;
  }
}
</code></pre><br><br><h2>Overview</h2><p>The Observability SDK provides context-aware logging, offering exceptional tools for tracking application behavior and quickly identifying issues.</p><p>Using the <code>ollyv</code> SDK, context-aware structured log is created in a distributed microservice Lambda environment. It also allows you to maintain a tenant context between other services that interact with Lambda. And Logger can be configured using the configuration which should be defined by yourself.</p><p>Using this module in the Lambda function will operate internally as shown below.</p><p><img src="images/ollyv-lambda-diagram.png" alt=""></p><br><br><h2>Package Structure</h2><pre class="prettyprint source"><code>
ollyv/lambda
  │
  ├──  ...
  ├──  configs/ : configurations for build and packaging
  │      ├─  package.cjs.json
  │      └─  package.esm.json
  ├──  docs/ : documents (README.md, images, etc.)
  │      ├─  images
  │      └─  ...
  ├──  examples/ : example codes
  │      ├─  example code
  │      └─  ...
  ├──  dist/ : transpiled output of the package
  │      ├─  cjs/ : support the use of package in commonjs type
  │      │     ├─  compiled output for commonjs
  │      │     ├─  compiled output for commonjs
  │      │     └─  ...
  │      ├─  esm/ : support the use of package in es module type
  │      │     ├─  compiled output for esmodule
  │      │     ├─  compiled output for esmodule
  │      │     └─  ...
  │      └─  layers/ : archive of lambda extension .zip
  │            └─  extension.zip
  ├──  src/
  │      ├─  const/ : constants
  │      │     └─  contextTypeConst.js : constants needed for logger
  │      ├─  middleware/ : middlewares
  │      │     └─  interceptor.js :  extract & set tenant context to the logger ...
  │      ├─  service/ : Service Module
  │      │     ├─  contextExtractor.js : extract tenant context from token
  │      │     ├─  logFormatter.js : transform log format to structured JSON format based on log options from the configuration
  │      │     ├─  logger.js : logger module (powertools logger wrapper)
  │      │     ├─  tokenDirector.js : token(jwt) mangaer
  │      │     ├─  middlewares.js : where to declare all middleware to use
  │      │     └─  ...
  │      └─   index.js : where to declare all modules to be used as a package
  ├──  .babelrc : babel config for transpiling the package
  ├──  .npmignore : define excluded files for packaging
  ├──  jest.config.js : jest config file
  ├──  package.json
  ├──  README.md
  └──  ...



</code></pre><br><br><h2>Configuration</h2><p>To use the ollyv logger, config should be defined. To enable multiple lambda functions to use the global configuration, the following methods are recommended.</p><ol><li>Define config object in Layer. (or specific directory)</li><li>Defined as string in SSM Parameter Store</li><li>Defining as Json Config in AppConfig</li></ol><br><p>Please see the below description of the configuration.</p><pre class="prettyprint source lang-json"><code>{
  // whether enable or disable logger
  &quot;enableLogging&quot;: true,
  &quot;logOptions&quot;: {
    // whether to append the trace id to the logger
    &quot;ENABLE_XRAY_TRACE_ID&quot;: true,
    // whether to append the function name to the logger
    &quot;ENABLE_CALLER&quot;: true,
    // when 'ENABLE_CALLER' is 'true', prefix of the caller
    &quot;CALLER_PREFIX&quot;: &quot;lambda:&quot;
  },
  &quot;logConst&quot;: {
    // string to be set when tenant context can't be identified
    &quot;UNKNOWN&quot;: &quot;unknown&quot;,
    // key value when adding the extracted context to the lambda event payload
    &quot;SET_CONTEXT_INTO_LAMBDA_PAYLOAD_KEY&quot;: &quot;_logContext&quot;,
    // key value of the JWT
    &quot;LOG_CONTEXT_FROM_TOKEN_KEY&quot;: &quot;headers.Authorization&quot;,
    // key value of the tenanat context, if it is invoked from another lambda function
    &quot;LOG_CONTEXT_FROM_LAMBDA_KEY&quot;: &quot;_logContext&quot;,
    // key value of the tenanat context, if it is triggered from SQS
    &quot;LOG_CONTEXT_FROM_SQS_KEY&quot;: &quot;messageAttributes.logAttributes.stringValue&quot;,
    // key value of the tenanat context, if it is invoked from ECS
    &quot;LOG_CONTEXT_FROM_ECS_KEY&quot;: &quot;_logContext&quot;
  },
  // log format when tenant context extracted form JWT and it is appended to logger
  &quot;headerLogFormat&quot;: {
    // configure the log format using dot notation expression
    // e.g) &quot;&lt;key of tenant context in JWT>&quot;: &quot;&lt;key to be set into logger>&quot;
  &quot;tenant.tenantId&quot;   : &quot;tenantContext.tenantId&quot;,
  &quot;tenant.tenantName&quot; : &quot;tenantContext.tenantName&quot;,
  &quot;tenant.plan&quot;       : &quot;tenantContext.plan&quot;,
  &quot;account.userId&quot;    : &quot;userContext.userId&quot;,
  &quot;account.gender&quot;    : &quot;userContext.gender&quot;,
  &quot;account.role&quot;      : &quot;userContext.role&quot;,
  }
}
</code></pre><br><br><h2>Deployment</h2><p>When deploying lambda fuctions and layers, the Lambda environment variables and configuration that should be set for SDK use are as follows.</p><p>[Layers]</p><ul><li>🐿️ <code>@ollyv</code> should be included as a dependency and deployed to layer</li></ul><p>[Environment Variable]</p><ul><li>🐿️ No environmental variables required</li></ul><p>[Runtime]</p><ul><li>🐿️ Node 16.x~ (Node 18 is recommended)</li></ul><br><br><h3>Development</h3><p>To apply the logging module to a lambda function, follow this steps:</p><p>1️⃣ Import the Logger, middleware, and interceptor from the ollyv/sdk-lambda-logging module. It is included as a dependency in the lambda layer. Also, import the LOG_CONFIG which should be defined by yourself.</p><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;
const { Logger, middlewares, interceptor } = require('@ollyv/lambda');
</code></pre><p>2️⃣ Create a Logger with the log configuration, which is in the <code>&lt;path/to/config&gt;</code></p><blockquote><p>The LOG_CONFIG might be defined in the <code>&lt;path/to/config&gt;</code>. This means that the configuration of the logger is a parameter in the parameter store. If LOG_CONFIG is not specified or if <code>“enableLogging&quot;=false</code> in <code>LOG_CONFIG</code>, <code>logger.info()</code> internally outputs the log using <code>console.log()</code>.</p></blockquote><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;
const { Logger, middlewares, interceptor } = require('@ollyv/lambda');

const logger = new Logger(LOG_CONFIG);
</code></pre><blockquote><p>(Optional) Logger can be created with logLevel, serviceName options. If logLevel options is set to one of <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>, <code>DEBUG</code>, logger will be set it’s log level. And, if serviceName is set to some string value, it will always be presented in the service_name of the log.</p></blockquote><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;
const logger = new Logger(LOG_CONFIG, { serviceName: 'my-servie', logLevel: 'INFO' });
</code></pre><p>3️⃣ Modify the Lambda's handler function to a constant variable.</p><pre class="prettyprint source lang-javascript"><code>const lambdeHandler = async (event, context) => { ... }
</code></pre><p>4️⃣ Register the ollyv interceptor as middleware with the logger at the bottom of the Lambda function.</p><blockquote><p>This way, before entering the lambda handler function, the ollyv module's interceptor will execute. It intercepts the incoming request, extracts the tenant context in an appropriate manner for each event source, and structures the log accordingly.</p></blockquote><pre class="prettyprint source lang-javascript"><code>const lambdeHandler = async (event, context) => {
...
}
exports.handler = middlewares(lambdaHandler).use(interceptor(logger));
</code></pre><p>5️⃣ Change all existing console.log() statements in the Lambda function to appropriate log levels like logger.info(), logger.error(), etc. By doing this, the context-aware structured log will be applied within the Lambda function.</p><pre class="prettyprint source lang-javascript"><code>const lambdaHandler = async (event, context) => {
// replace console.log() to logger.info()
logger.info('Hello from lambda');
logger.debug('Hello from lambda');
logger.error('Hello from lambda');
logger.warn('Hello from lambda');
...
};
</code></pre><p>6️⃣ (Conditional) If the Lambda function uses other javascript classes to call other AWS services, you need to propagate the tenant context to the target services.</p><p>7️⃣ (Conditional) Only for SQS trigger Lambda</p><blockquote><p><em>This case is only applicable if the lambda function is sqs trigger lambda.</em></p></blockquote><blockquote><p>If lambda receive only one message from SQS, tenant context is automatically extracted from single message at middleware called interceptor. But, if lambda function receive multiple SQS records at once, interceptor can’t specify the tenant context. Because, each record of SQS message has a different context. In this case, log context is set 'unknown_batch'. So, you should append the context into logger function where process each SQS message using logger.appendContextFromSQSMessage() of Logger module.</p></blockquote><pre class="prettyprint source lang-javascript"><code>// Example

exports.handler = async (event) => {
  const messages = async (deviceEventMessage) => {
    // process each message
    for (const message of deviceEventMessage.Records) {
      // Log context should be set from single message
      logger.appendContextFromSQSMessage(message);
      const body = JSON.parse(message.body);
      const { screenId } = body;
      console.log(`[${screenId}] message : ${JSON.stringify(body)}`);
      try {
        await enrollment(screenId);
      } catch (e) {
        console.log(`[${screenId}][ERROR] ${e.message}`);
      }
    }
  };
  await messages(event);
};
</code></pre><br><br><p>As a result, the lambda function is changed as follows.</p><p><strong>[AS-IS]</strong></p><pre class="prettyprint source lang-javascript"><code>exports.handler = async (event, context) => {
  console.log('Hello from Lambda');
  console.log('Hello from Lambda');
  console.log('Hello from Lambda');
  console.log('Hello from Lambda');

  return {
    statusCode: 200,
    body: JSON.stringify({
      response: 'success',
    }),
  };
};
</code></pre><p><strong>[TO-BE]</strong></p><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;
const { Logger, middlewares, interceptor } = require('@ollyv/lambda');
const logger = new Logger(LOG_CONFIG);
...

const lambdaHandler = async (event, context) => {
...
logger.info('Hello from Lambda');
logger.debug('Hello from Lambda');
logger.error('Hello from Lambda');
logger.warn('Hello from Lambda');

// If the Lambda function uses services,
// you need to propagate the tenant context to the target services.

};

exports.handler = middlewares(lambdaHandler).use(interceptor(logger));

</code></pre><p>The log is output as follows.</p><ol><li><p>logger.info()</p><pre class="prettyprint source lang-json"><code>{
  &quot;level&quot;: &quot;INFO&quot;,
  &quot;message&quot;: &quot;Hello from Lambda&quot;,
  &quot;service&quot;: &quot;&lt;lambda-function-name>&quot;,
  &quot;timestamp&quot;: &quot;2023-06-26T13:03:34.639Z&quot;,
  &quot;xray_trace_id&quot;: &quot;1-64998ca6-47085075585a5c65164ff3d3&quot;,
  &quot;tenantContext&quot;: {
    &quot;tenantId&quot;: &quot;EA003DC7-C155-431D-876E-EDF37CBBCCB0&quot;,
    &quot;tenantName&quot;: &quot;proserve&quot;,
    &quot;plan&quot;: &quot;Trial&quot;
  },
  &quot;userContext&quot;: {
    &quot;userId&quot;: &quot;C75D6EE0-8FE9-4918-8EEA-1DC382521771&quot;,
    &quot;gender&quot;: &quot;female&quot;,
    &quot;role&quot;: &quot;CUSTOMER&quot;
  },
  &quot;caller&quot;: &quot;lambda:/var/task/index.js:56:16&quot;,
  &quot;traceId&quot;: &quot;undefined&quot;
}
</code></pre></li><li><p>console.log()</p><pre class="prettyprint source"><code>2023-08-31T05:14:32.677Z	3eb7caf0-5381-4202-8b72-11b00ed4159d	INFO	Hello from Lambda
</code></pre><br><br></li></ol><h4>Logger for JavaScript calss</h4><p>If you want to <code>ollyv</code> Logger for JavaScript class, please follow these steps.</p><ol><li><p>Import the Logger from the <code>@ollyv/lambda</code> module and <code>LOG_CONFIG</code> which should be defined by yourseld, and declare the logger as let variable.</p><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;
const { Logger } = require('@ollyv/lambda');
let logger;
</code></pre></li><li><p>At the beginning of the constructor function, create logger with the LOG_CONFIG in <code>'&lt;path/to/config&gt;</code>.</p><pre class="prettyprint source lang-javascript"><code> class MyClass {
   constructor() {
   if(!logger) {
   logger = new Logger(LOG_CONFIG);
   }
   }
   ...
   }
</code></pre><blockquote><p>(Optional) Logger can be created with logLevel, serviceName options. If logLevel options is set to one of <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>, <code>DEBUG</code>, logger will be set it’s log level. And, if serviceName is set to some string value, it will always be presented in the <code>service</code> of the log.</p></blockquote><pre class="prettyprint source lang-javascript"><code>const LOG_CONFIG = &lt;path/to/config>;

class MyClass {
constructor() {
  if(!logger) {
    logger=new Logger(LOG_CONFIG, {serviceName: 'my-servie', logLevel: 'INFO'});
    }
  }
...
}
</code></pre></li><li><p>Replace all existing <code>console.log()</code> statements in the Lambda function to appropriate log levels like <code>logger.info()</code>, logger.error(), etc.</p><blockquote><p>In this way, a log in the format of a structured JSON is generated. The logger may know <code>caller</code> and <code>traceId</code>, but the tenant context is output as <code>unknown</code>. This is because if you don't inject tenant context directly, logger can't know it.</p></blockquote></li></ol><br><br><h3>Debugging</h3><ul><li>🔎 When the log context set to <code>unknown</code>?<ul><li>💡 Token(JWT) has no tenant context</li><li>💡 Invalid configuration of the Logger</li></ul></li><li>🔎 When the log context set to <code>unknown_batch</code>?<ul><li>💡 Multiple SQS message records</li></ul></li></ul><br><br><h3>References</h3><ul><li>📙 <a href="https://aws-observability.github.io/observability-best-practices/signals/logs/#structured-logging-is-key-to-success">AWS Obeservability Best Practices</a></li><li>📙 <a href="https://docs.aws.amazon.com/wellarchitected/latest/serverless-applications-lens/welcome.html">Serverless Applications Lens</a> - AWS Well-Architected Framework</li><li>📙 <a href="https://docs.aws.amazon.com/wellarchitected/latest/saas-lens/saas-lens.html">SaaS Lens</a> - AWS Well-Architected Framework</li></ul></article></section></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="index.html" class="sidebar-title">O11yv: NodeLambda</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="StArcPJeAizsHwRj7W8ut"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ContextExtractor.html">ContextExtractor</a></div><div class="sidebar-section-children"><a href="LogFormatter.html">LogFormatter</a></div><div class="sidebar-section-children"><a href="TenantLogger.html">TenantLogger</a></div><div class="sidebar-section-children"><a href="TokenDirector.html">TokenDirector</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="0Y93mRfzQyrdAwDSQNq9x"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#appendContextFromSQSMessage">appendContextFromSQSMessage</a></div><div class="sidebar-section-children"><a href="global.html#appendKeys">appendKeys</a></div><div class="sidebar-section-children"><a href="global.html#apply">apply</a></div><div class="sidebar-section-children"><a href="global.html#decode">decode</a></div><div class="sidebar-section-children"><a href="global.html#extract">extract</a></div><div class="sidebar-section-children"><a href="global.html#extractFromEventByKey">extractFromEventByKey</a></div><div class="sidebar-section-children"><a href="global.html#extractFromSQSMessageAttributes">extractFromSQSMessageAttributes</a></div><div class="sidebar-section-children"><a href="global.html#extractFromSQSMessages">extractFromSQSMessages</a></div><div class="sidebar-section-children"><a href="global.html#extractRootfromTraceId">extractRootfromTraceId</a></div><div class="sidebar-section-children"><a href="global.html#getJwtFromRequest">getJwtFromRequest</a></div><div class="sidebar-section-children"><a href="global.html#getLogContext">getLogContext</a></div><div class="sidebar-section-children"><a href="global.html#initFormat">initFormat</a></div><div class="sidebar-section-children"><a href="global.html#initLogger">initLogger</a></div><div class="sidebar-section-children"><a href="global.html#interceptor">interceptor</a></div><div class="sidebar-section-children"><a href="global.html#setLogLevel">setLogLevel</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>